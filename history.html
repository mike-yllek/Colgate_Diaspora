<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League History - Colgate Diaspora Fantasy League</title>
    
    <!-- jQuery first -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
    
    <!-- Your custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .view-toggle {
            margin-bottom: 2rem;
        }

        .view-toggle button {
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #ddd;
        }

        .view-toggle button.active {
            background-color: var(--primary-color);
            color: white;
        }

        #error-message {
            color: red;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f8f8f8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>League History</h1>
        
        <div id="error-message"></div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button id="seasonView" class="active">Season View</button>
            <button id="allTimeView">All-Time Standings</button>
        </div>

        <!-- Season Filter -->
        <div id="seasonFilter">
            <label for="seasonSelect">Select Season:</label>
            <select id="seasonSelect"></select>
        </div>

        <!-- Season-by-Season Table -->
        <div id="seasonTable">
            <table id="seasonData">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Ties</th>
                        <th>Points For</th>
                        <th>Points Against</th>
                        <th>F-Average</th>
                        <th>A-Average</th>
                        <th>Playoffs</th>
                        <th>Championship</th>
                        <th>Season</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- All-Time Standings Table -->
        <div id="allTimeTable" style="display: none;">
            <table id="standingsData">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Ties</th>
                        <th>Seasons</th>
                        <th>Win %</th>
                        <th>Points For</th>
                        <th>Points Against</th>
                        <th>F-Average Total</th>
                        <th>A-Average Total</th>
                        <th>Playoff Appearances</th>
                        <th>Championships</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // This will store our parsed CSV data
            let leagueData = [];
            let allTimeStats = {};

            // Function to display errors
            function showError(message) {
                document.getElementById('error-message').textContent = message;
            }

            // Function to filter table by season
            function filterBySeason(season) {
                const seasonTable = $('#seasonData').DataTable();
                if (season === 'all') {
                    seasonTable.column(10).search('').draw();
                } else {
                    seasonTable.column(10).search('^' + season + '$', true, false).draw();
                }
            }

            // Function to load and parse CSV data
            async function loadData() {
                try {
                    console.log('Starting data load...');
                    const response = await fetch('data/Colgate_Diaspora_History_CSV_Long.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    console.log('CSV loaded, first 100 chars:', csvText.substring(0, 100));
                    
                    leagueData = parseCSV(csvText);
                    console.log('Parsed data:', leagueData.slice(0, 2));
                    
                    processData();
                    initializeTables();
                } catch (error) {
                    console.error('Error loading data:', error);
                    showError('Error loading data: ' + error.message);
                }
            }

            // Parse CSV text into array of objects for season data
            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                console.log('Number of lines:', lines.length);
                
                if (lines.length < 2) {
                    throw new Error('CSV file appears to be empty or malformed');
                }

                const headers = lines[0].split(',');
                console.log('Headers:', headers);

                return lines.slice(1)
                    .filter(line => line.trim())
                    .map(line => {
                        const values = line.split(',');
                        return {
                            Team: values[0],
                            Wins: parseInt(values[1]),
                            Losses: parseInt(values[2]),
                            Ties: parseInt(values[3]),
                            PointsFor: parseFloat(values[6]),
                            PointsAgainst: parseFloat(values[7]),
                            FAvergage: parseFloat(values[8]),
                            AAverage: parseFloat(values[9]),
                            Playoffs: values[10] === '1' ? '1' : '0',
                            Championship: values[11] === '1' ? '1' : '0',
                            Season: values[4]
                        };
                    })
                    .filter(row => row.Team && row.Team.trim() !== '');
            }

            // Process data for all-time standings
            function processData() {
                console.log('Processing data...');
                allTimeStats = leagueData.reduce((acc, row) => {
                    if (!acc[row.Team]) {
                        acc[row.Team] = {
                            seasons: new Set(),
                            wins: 0,
                            losses: 0,
                            ties: 0,
                            pointsFor: 0,
                            pointsAgainst: 0,
                            playoffs: 0,
                            championships: 0,
                            fAverageTotal: 0,
                            aAverageTotal: 0,
                            gamesPlayed: 0,
                            validGames: 0,
                            validScores: 0
                        };
                    }
                    
                    const stats = acc[row.Team];
                    stats.seasons.add(row.Season);
                    
                    // Handle wins, losses, ties
                    if (row.Wins !== 'NA') stats.wins += row.Wins;
                    if (row.Losses !== 'NA') stats.losses += row.Losses;
                    if (row.Ties !== 'NA') stats.ties += row.Ties;
                    
                    // Handle points and averages
                    if (row.PointsFor !== 'NA') {
                        stats.pointsFor += row.PointsFor;
                        stats.validScores++;
                    }
                    if (row.PointsAgainst !== 'NA') {
                        stats.pointsAgainst += row.PointsAgainst;
                    }
                    if (row.FAvergage !== 'NA') stats.fAverageTotal += row.FAvergage;
                    if (row.AAverage !== 'NA') stats.aAverageTotal += row.AAverage;
                    
                    // Handle playoffs and championships
                    if (row.Playoffs === '1') stats.playoffs++;
                    if (row.Championship === '1') stats.championships++;
                    
                    // Count valid games
                    if (row.Wins !== 'NA' && row.Losses !== 'NA' && row.Ties !== 'NA') {
                        stats.gamesPlayed += row.Wins + row.Losses + row.Ties;
                        stats.validGames++;
                    }
                    
                    return acc;
                }, {});

                // Populate season filter
                const seasons = [...new Set(leagueData.map(row => row.Season))].sort().reverse();
                const select = document.getElementById('seasonSelect');
                select.innerHTML = '<option value="all">All Seasons</option>' +
                    seasons.map(season => `<option value="${season}">${season}</option>`).join('');
            }

            // Function to load totals data
            async function loadTotalsData() {
                try {
                    const response = await fetch('data/Colgate_Diaspora_History_CSV_Long_Totals_2025.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    
                    return csvText.trim()
                        .split('\n')
                        .filter(line => line.trim() && !line.startsWith(','))
                        .map(line => {
                            const values = line.split(',');
                            if (!values[0] || !values[0].trim()) return null;
                            
                            return {
                                Team: values[0].trim(),
                                Wins: parseInt(values[1]),
                                Losses: parseInt(values[2]),
                                Ties: parseInt(values[3]),
                                Seasons: parseInt(values[4]),
                                WinPercentage: parseFloat(values[5]),
                                PointsFor: parseFloat(values[6]),
                                PointsAgainst: parseFloat(values[7]),
                                FAverageTotal: parseFloat(values[8]),
                                AAverageTotal: parseFloat(values[9]),
                                PlayoffAppearances: parseInt(values[10]),
                                Championships: parseInt(values[11])
                            };
                        })
                        .filter(row => row !== null);
                } catch (error) {
                    console.error('Error loading totals data:', error);
                    showError('Error loading totals data: ' + error.message);
                    return [];
                }
            }

            // Update the initializeTables function
            function initializeTables() {
                console.log('Initializing tables...');
                try {
                    // Season Table
                    const seasonTable = $('#seasonData').DataTable({
                        data: leagueData,
                        columns: [
                            { data: 'Team' },
                            { data: 'Wins' },
                            { data: 'Losses' },
                            { data: 'Ties' },
                            { data: 'PointsFor' },
                            { data: 'PointsAgainst' },
                            { data: 'FAvergage' },
                            { data: 'AAverage' },
                            { 
                                data: 'Playoffs',
                                render: function(data) {
                                    return data === '1' ? 'Yes' : 'No';
                                }
                            },
                            { 
                                data: 'Championship',
                                render: function(data) {
                                    return data === '1' ? 'Yes' : 'No';
                                }
                            },
                            { data: 'Season' }
                        ],
                        pageLength: 15,
                        order: [[10, 'desc'], [1, 'desc']]
                    });

                    // Add event listener for season selection
                    $('#seasonSelect').on('change', function() {
                        const selectedSeason = $(this).val();
                        filterBySeason(selectedSeason);
                    });

                    // All-Time Standings Table
                    const totalsData = await loadTotalsData();
                    const standingsTable = $('#standingsData').DataTable({
                        data: totalsData,
                        columns: [
                            { data: 'Team' },
                            { data: 'Wins' },
                            { data: 'Losses' },
                            { data: 'Ties' },
                            { data: 'Seasons' },
                            { 
                                data: 'WinPercentage',
                                render: value => (value * 100).toFixed(1) + '%'
                            },
                            { data: 'PointsFor' },
                            { data: 'PointsAgainst' },
                            { 
                                data: 'FAverageTotal',
                                render: value => value.toFixed(1)
                            },
                            { 
                                data: 'AAverageTotal',
                                render: value => value.toFixed(1)
                            },
                            { data: 'PlayoffAppearances' },
                            { data: 'Championships' }
                        ],
                        pageLength: 15,
                        order: [[11, 'desc'], [10, 'desc'], [5, 'desc']]
                    });

                    console.log('Tables initialized successfully');
                } catch (error) {
                    console.error('Error initializing tables:', error);
                    showError('Error initializing tables: ' + error.message);
                }
            }

            // View toggle handlers
            $('#seasonView').click(function() {
                $(this).addClass('active');
                $('#allTimeView').removeClass('active');
                $('#seasonTable').show();
                $('#allTimeTable').hide();
            });

            $('#allTimeView').click(function() {
                $(this).addClass('active');
                $('#seasonView').removeClass('active');
                $('#seasonTable').hide();
                $('#allTimeTable').show();
            });

            // Start loading data
            console.log('Document ready, loading data...');
            loadData();
        });
    </script>
</body>
</html>