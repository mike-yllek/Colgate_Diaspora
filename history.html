<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League History - Colgate Diaspora Fantasy League</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
    <style>
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .view-toggle {
            margin-bottom: 2rem;
        }

        .view-toggle button {
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #ddd;
        }

        .view-toggle button.active {
            background-color: var(--primary-color);
            color: white;
        }

        #error-message {
            color: red;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f8f8f8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>League History</h1>
        
        <div id="error-message"></div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button id="seasonView" class="active">Season View</button>
            <button id="allTimeView">All-Time Standings</button>
        </div>

        <!-- Season Filter -->
        <div id="seasonFilter">
            <label for="seasonSelect">Select Season:</label>
            <select id="seasonSelect"></select>
        </div>

        <!-- Season-by-Season Table -->
        <div id="seasonTable">
            <table id="seasonData">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Ties</th>
                        <th>Points For</th>
                        <th>Points Against</th>
                        <th>F-Average</th>
                        <th>A-Average</th>
                        <th>Playoffs</th>
                        <th>Championship</th>
                        <th>Season</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- All-Time Standings Table -->
        <div id="allTimeTable" style="display: none;">
            <table id="standingsData">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Seasons</th>
                        <th>Total Wins</th>
                        <th>Total Losses</th>
                        <th>Total Ties</th>
                        <th>Win %</th>
                        <th>Total Points For</th>
                        <th>Total Points Against</th>
                        <th>Avg F-Average</th>
                        <th>Avg A-Average</th>
                        <th>Playoff Appearances</th>
                        <th>Championships</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>

    <script>
        // This will store our parsed CSV data
        let leagueData = [];
        let allTimeStats = {};

        // Function to display errors
        function showError(message) {
            document.getElementById('error-message').textContent = message;
        }

        // Function to load and parse CSV data
        async function loadData() {
            try {
                console.log('Starting data load...');
                const response = await fetch('data/Colgate Diaspora - Sheet6.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                console.log('CSV loaded, first 100 chars:', csvText.substring(0, 100));
                
                leagueData = parseCSV(csvText);
                console.log('Parsed data:', leagueData.slice(0, 2));
                
                processData();
                initializeTables();
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error loading data: ' + error.message);
            }
        }

        // Parse CSV text into array of objects
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            console.log('Number of lines:', lines.length);
            
            if (lines.length < 2) {
                throw new Error('CSV file appears to be empty or malformed');
            }

            const headers = lines[0].split('\t');
            console.log('Headers:', headers);

            return lines.slice(1)
                .filter(line => line.trim())
                .map(line => {
                    const values = line.split('\t');
                    const row = {
                        Team: values[0],
                        Wins: parseInt(values[1]) || 0,
                        Losses: parseInt(values[2]) || 0,
                        Ties: parseInt(values[3]) || 0,
                        PointsFor: parseFloat(values[4]) || 0,
                        PointsAgainst: parseFloat(values[5]) || 0,
                        FAvergage: parseFloat(values[6]) || 0,
                        AAverage: parseFloat(values[7]) || 0,
                        Playoffs: values[8] ? values[8].trim() : '',
                        Championship: values[9] ? values[9].trim() : '',
                        Season: values[10] ? values[10].trim() : ''
                    };
                    return row;
                })
                .filter(row => row.Team && row.Season);
        }

        // Process data for all-time standings
        function processData() {
            console.log('Processing data...');
            allTimeStats = leagueData.reduce((acc, row) => {
                if (!acc[row.Team]) {
                    acc[row.Team] = {
                        seasons: new Set(),
                        wins: 0,
                        losses: 0,
                        ties: 0,
                        pointsFor: 0,
                        pointsAgainst: 0,
                        playoffs: 0,
                        championships: 0,
                        fAverageTotal: 0,
                        aAverageTotal: 0,
                        gamesPlayed: 0
                    };
                }
                
                const stats = acc[row.Team];
                if (row.Wins > 0 || row.Losses > 0 || row.Ties > 0) {
                    stats.seasons.add(row.Season);
                    stats.wins += row.Wins;
                    stats.losses += row.Losses;
                    stats.ties += row.Ties;
                    stats.pointsFor += row.PointsFor;
                    stats.pointsAgainst += row.PointsAgainst;
                    stats.playoffs += row.Playoffs === '1' ? 1 : 0;
                    stats.championships += row.Championship === '1' ? 1 : 0;
                    stats.fAverageTotal += row.FAvergage;
                    stats.aAverageTotal += row.AAverage;
                    stats.gamesPlayed += row.Wins + row.Losses + row.Ties;
                }
                
                return acc;
            }, {});

            console.log('Processed stats:', allTimeStats);

            // Populate season filter
            const seasons = [...new Set(leagueData.map(row => row.Season))].sort().reverse();
            const select = document.getElementById('seasonSelect');
            select.innerHTML = '<option value="all">All Seasons</option>' +
                seasons.map(season => `<option value="${season}">${season}</option>`).join('');
        }

        // Initialize DataTables
        function initializeTables() {
            console.log('Initializing tables...');
            try {
                // Season Table
                const seasonTable = $('#seasonData').DataTable({
                    data: leagueData,
                    columns: [
                        { data: 'Team' },
                        { data: 'Wins' },
                        { data: 'Losses' },
                        { data: 'Ties' },
                        { data: 'PointsFor', render: value => value.toFixed(1) },
                        { data: 'PointsAgainst', render: value => value.toFixed(1) },
                        { data: 'FAvergage', render: value => value.toFixed(1) },
                        { data: 'AAverage', render: value => value.toFixed(1) },
                        { 
                            data: 'Playoffs',
                            render: function(data) {
                                if (data === '') return 'N/A';
                                return data === '1' ? 'Yes' : 'No';
                            }
                        },
                        { 
                            data: 'Championship',
                            render: function(data) {
                                if (data === '') return 'N/A';
                                return data === '1' ? 'Yes' : 'No';
                            }
                        },
                        { data: 'Season' }
                    ],
                    pageLength: 15,
                    order: [[10, 'desc'], [1, 'desc']]
                });

                // All-Time Standings Table
                const standingsTable = $('#standingsData').DataTable({
                    data: Object.entries(allTimeStats).map(([team, stats]) => ({
                        team,
                        seasons: stats.seasons.size,
                        wins: stats.wins,
                        losses: stats.losses,
                        ties: stats.ties,
                        winPct: stats.gamesPlayed > 0 ? 
                            ((stats.wins / stats.gamesPlayed) * 100).toFixed(1) + '%' : 
                            '0.0%',
                        pointsFor: (stats.pointsFor / stats.seasons.size).toFixed(1),
                        pointsAgainst: (stats.pointsAgainst / stats.seasons.size).toFixed(1),
                        fAverage: (stats.fAverageTotal / stats.seasons.size).toFixed(1),
                        aAverage: (stats.aAverageTotal / stats.seasons.size).toFixed(1),
                        playoffs: stats.playoffs,
                        championships: stats.championships
                    })),
                    columns: [
                        { data: 'team' },
                        { data: 'seasons' },
                        { data: 'wins' },
                        { data: 'losses' },
                        { data: 'ties' },
                        { data: 'winPct' },
                        { data: 'pointsFor' },
                        { data: 'pointsAgainst' },
                        { data: 'fAverage' },
                        { data: 'aAverage' },
                        { data: 'playoffs' },
                        { data: 'championships' }
                    ],
                    pageLength: 15,
                    order: [[11, 'desc'], [10, 'desc'], [5, 'desc']]
                });

                console.log('Tables initialized successfully');
            } catch (error) {
                console.error('Error initializing tables:', error);
                showError('Error initializing tables: ' + error.message);
            }
        }

        // View toggle handlers
        $('#seasonView').click(function() {
            $(this).addClass('active');
            $('#allTimeView').removeClass('active');
            $('#seasonTable').show();
            $('#allTimeTable').hide();
        });

        $('#allTimeView').click(function() {
            $(this).addClass('active');
            $('#seasonView').removeClass('active');
            $('#seasonTable').hide();
            $('#allTimeTable').show();
        });

        // Initialize when document is ready
        $(document).ready(function() {
            console.log('Document ready, loading data...');
            loadData();
        });
    </script>
</body>
</html>
