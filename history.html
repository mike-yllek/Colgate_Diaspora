<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League History - Colgate Diaspora Fantasy League</title>
    
    <!-- jQuery first -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
    
    <!-- Your custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .view-toggle {
            margin-bottom: 2rem;
        }

        .view-toggle button {
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #ddd;
        }

        .view-toggle button.active {
            background-color: var(--primary-color);
            color: white;
        }

        #error-message {
            color: red;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f8f8f8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>League History</h1>
        
        <div id="error-message"></div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button id="seasonView" class="active">Season View</button>
            <button id="allTimeView">All-Time Standings</button>
        </div>

        <!-- Season Filter -->
        <div id="seasonFilter">
            <label for="seasonSelect">Select Season:</label>
            <select id="seasonSelect"></select>
        </div>

        <!-- Season-by-Season Table -->
        <div id="seasonTable">
            <table id="seasonData">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Ties</th>
                        <th>Points For</th>
                        <th>Points Against</th>
                        <th>F-Average</th>
                        <th>A-Average</th>
                        <th>Playoffs</th>
                        <th>Championship</th>
                        <th>Season</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- All-Time Standings Table -->
        <div id="allTimeTable" style="display: none;">
            <table id="standingsData">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Seasons</th>
                        <th>Total Wins</th>
                        <th>Total Losses</th>
                        <th>Total Ties</th>
                        <th>Win %</th>
                        <th>Total Points For</th>
                        <th>Total Points Against</th>
                        <th>Avg F-Average</th>
                        <th>Avg A-Average</th>
                        <th>Playoff Appearances</th>
                        <th>Championships</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // This will store our parsed CSV data
            let leagueData = [];
            let allTimeStats = {};

            // Function to display errors
            function showError(message) {
                document.getElementById('error-message').textContent = message;
            }

            // Function to load and parse CSV data
            async function loadData() {
                try {
                    console.log('Starting data load...');
                    const response = await fetch('data/Colgate_Diaspora_History_CSV_Long.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    console.log('CSV loaded, first 100 chars:', csvText.substring(0, 100));
                    
                    leagueData = parseCSV(csvText);
                    console.log('Parsed data:', leagueData.slice(0, 2));
                    
                    processData();
                    initializeTables();
                } catch (error) {
                    console.error('Error loading data:', error);
                    showError('Error loading data: ' + error.message);
                }
            }

            // Parse CSV text into array of objects
            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                console.log('Number of lines:', lines.length);
                
                if (lines.length < 2) {
                    throw new Error('CSV file appears to be empty or malformed');
                }

                const headers = lines[0].split(',');
                console.log('Headers:', headers);

                return lines.slice(1)
                    .filter(line => line.trim())
                    .map(line => {
                        const values = line.split(',');
                        const row = {
                            Team: values[0] || 'NA',
                            Wins: values[1] && values[1].trim() !== '' ? parseInt(values[1]) : 'NA',
                            Losses: values[2] && values[2].trim() !== '' ? parseInt(values[2]) : 'NA',
                            Ties: values[3] && values[3].trim() !== '' ? parseInt(values[3]) : 'NA',
                            PointsFor: values[4] && values[4].trim() !== '' ? parseFloat(values[4]) : 'NA',
                            PointsAgainst: values[5] && values[5].trim() !== '' ? parseFloat(values[5]) : 'NA',
                            FAvergage: values[6] && values[6].trim() !== '' ? parseFloat(values[6]) : 'NA',
                            AAverage: values[7] && values[7].trim() !== '' ? parseFloat(values[7]) : 'NA',
                            Playoffs: values[8] ? values[8].trim() : 'NA',
                            Championship: values[9] ? values[9].trim() : 'NA',
                            Participated: values[10] ? values[10].trim() : 'NA',
                            Season: values[11] ? values[11].trim() : 'NA'
                        };
                        return row;
                    })
                    .filter(row => row.Team !== 'NA' && row.Season !== 'NA' && row.Participated === '1');
            }

            // Process data for all-time standings
            function processData() {
                console.log('Processing data...');
                allTimeStats = leagueData.reduce((acc, row) => {
                    if (!acc[row.Team]) {
                        acc[row.Team] = {
                            seasons: new Set(),
                            wins: 0,
                            losses: 0,
                            ties: 0,
                            pointsFor: 0,
                            pointsAgainst: 0,
                            playoffs: 0,
                            championships: 0,
                            fAverageTotal: 0,
                            aAverageTotal: 0,
                            gamesPlayed: 0,
                            validGames: 0,
                            validScores: 0
                        };
                    }
                    
                    const stats = acc[row.Team];
                    stats.seasons.add(row.Season);
                    
                    // Handle wins, losses, ties
                    if (row.Wins !== 'NA') stats.wins += row.Wins;
                    if (row.Losses !== 'NA') stats.losses += row.Losses;
                    if (row.Ties !== 'NA') stats.ties += row.Ties;
                    
                    // Handle points and averages
                    if (row.PointsFor !== 'NA') {
                        stats.pointsFor += row.PointsFor;
                        stats.validScores++;
                    }
                    if (row.PointsAgainst !== 'NA') {
                        stats.pointsAgainst += row.PointsAgainst;
                    }
                    if (row.FAvergage !== 'NA') stats.fAverageTotal += row.FAvergage;
                    if (row.AAverage !== 'NA') stats.aAverageTotal += row.AAverage;
                    
                    // Handle playoffs and championships
                    if (row.Playoffs === '1') stats.playoffs++;
                    if (row.Championship === '1') stats.championships++;
                    
                    // Count valid games
                    if (row.Wins !== 'NA' && row.Losses !== 'NA' && row.Ties !== 'NA') {
                        stats.gamesPlayed += row.Wins + row.Losses + row.Ties;
                        stats.validGames++;
                    }
                    
                    return acc;
                }, {});

                // Populate season filter
                const seasons = [...new Set(leagueData.map(row => row.Season))].sort().reverse();
                const select = document.getElementById('seasonSelect');
                select.innerHTML = '<option value="all">All Seasons</option>' +
                    seasons.map(season => `<option value="${season}">${season}</option>`).join('');
            }

            // Initialize DataTables
            function initializeTables() {
                console.log('Initializing tables...');
                try {
                    // Season Table
                    const seasonTable = $('#seasonData').DataTable({
                        data: leagueData,
                        columns: [
                            { data: 'Team' },
                            { 
                                data: 'Wins',
                                render: value => value === 'NA' ? 'NA' : value
                            },
                            { 
                                data: 'Losses',
                                render: value => value === 'NA' ? 'NA' : value
                            },
                            { 
                                data: 'Ties',
                                render: value => value === 'NA' ? 'NA' : value
                            },
                            { 
                                data: 'PointsFor',
                                render: value => value === 'NA' ? 'NA' : value.toFixed(1)
                            },
                            { 
                                data: 'PointsAgainst',
                                render: value => value === 'NA' ? 'NA' : value.toFixed(1)
                            },
                            { 
                                data: 'FAvergage',
                                render: value => value === 'NA' ? 'NA' : value.toFixed(1)
                            },
                            { 
                                data: 'AAverage',
                                render: value => value === 'NA' ? 'NA' : value.toFixed(1)
                            },
                            { 
                                data: 'Playoffs',
                                render: value => value === 'NA' ? 'NA' : (value === '1' ? 'Yes' : 'No')
                            },
                            { 
                                data: 'Championship',
                                render: value => value === 'NA' ? 'NA' : (value === '1' ? 'Yes' : 'No')
                            },
                            { data: 'Season' }
                        ],
                        pageLength: 15,
                        order: [[10, 'desc'], [1, 'desc']]
                    });

                    // All-Time Standings Table
                    const standingsTable = $('#standingsData').DataTable({
                        data: Object.entries(allTimeStats).map(([team, stats]) => ({
                            team,
                            seasons: stats.seasons.size,
                            wins: stats.wins,
                            losses: stats.losses,
                            ties: stats.ties,
                            winPct: stats.validGames > 0 ? 
                                ((stats.wins / stats.gamesPlayed) * 100).toFixed(1) + '%' : 
                                'NA',
                            pointsFor: stats.validScores > 0 ? 
                                (stats.pointsFor / stats.validScores).toFixed(1) : 
                                'NA',
                            pointsAgainst: stats.validScores > 0 ? 
                                (stats.pointsAgainst / stats.validScores).toFixed(1) : 
                                'NA',
                            fAverage: stats.validScores > 0 ? 
                                (stats.fAverageTotal / stats.validScores).toFixed(1) : 
                                'NA',
                            aAverage: stats.validScores > 0 ? 
                                (stats.aAverageTotal / stats.validScores).toFixed(1) : 
                                'NA',
                            playoffs: stats.playoffs,
                            championships: stats.championships
                        })),
                        columns: [
                            { data: 'team' },
                            { data: 'seasons' },
                            { data: 'wins' },
                            { data: 'losses' },
                            { data: 'ties' },
                            { data: 'winPct' },
                            { data: 'pointsFor' },
                            { data: 'pointsAgainst' },
                            { data: 'fAverage' },
                            { data: 'aAverage' },
                            { data: 'playoffs' },
                            { data: 'championships' }
                        ],
                        pageLength: 15,
                        order: [[11, 'desc'], [10, 'desc'], [5, 'desc']]
                    });

                    console.log('Tables initialized successfully');
                } catch (error) {
                    console.error('Error initializing tables:', error);
                    showError('Error initializing tables: ' + error.message);
                }
            }

            // View toggle handlers
            $('#seasonView').click(function() {
                $(this).addClass('active');
                $('#allTimeView').removeClass('active');
                $('#seasonTable').show();
                $('#allTimeTable').hide();
            });

            $('#allTimeView').click(function() {
                $(this).addClass('active');
                $('#seasonView').removeClass('active');
                $('#seasonTable').hide();
                $('#allTimeTable').show();
            });

            // Start loading data
            console.log('Document ready, loading data...');
            loadData();
        });
    </script>
</body>
</html>