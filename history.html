<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League History - Colgate Diaspora Fantasy League</title>
    
    <!-- jQuery first -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
    
    <!-- Your custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .view-toggle {
            margin-bottom: 2rem;
        }

        .view-toggle button {
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #ddd;
        }

        .view-toggle button.active {
            background-color: var(--primary-color);
            color: white;
        }

        #error-message {
            color: red;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f8f8f8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>League History</h1>
        
        <div id="error-message"></div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button id="seasonView" class="active">Season View</button>
            <button id="allTimeView">All-Time Standings</button>
        </div>

        <!-- Season Filter -->
        <div id="seasonFilter">
            <label for="seasonSelect">Select Season:</label>
            <select id="seasonSelect"></select>
        </div>

        <!-- Season-by-Season Table -->
        <div id="seasonTable">
            <table id="seasonData">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>W</th>
                        <th>L</th>
                        <th>T</th>
                        <th>PF</th>
                        <th>PA</th>
                        <th>F-average</th>
                        <th>A-average</th>
                        <th>Playoffs?</th>
                        <th>Championship</th>
                        <th>Participated?</th>
                        <th>Season</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- All-Time Standings Table -->
        <div id="allTimeTable" style="display: none;">
            <table id="standingsData">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>w</th>
                        <th>l</th>
                        <th>t</th>
                        <th>Seasons</th>
                        <th>Win Percentage</th>
                        <th>PF</th>
                        <th>PA</th>
                        <th>F-average Tot</th>
                        <th>A-average Tot</th>
                        <th>Playoff Appe</th>
                        <th>Championship</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // This will store our parsed CSV data
            let leagueData = [];
            let allTimeStats = {};

            // Function to display errors
            function showError(message) {
                document.getElementById('error-message').textContent = message;
            }

            // Function to filter table by season
            function filterBySeason(season) {
                const seasonTable = $('#seasonData').DataTable();
                if (season === 'all') {
                    seasonTable.column(11).search('').draw();
                } else {
                    seasonTable.column(11).search('^' + season + '$', true, false).draw();
                }
            }

            // Function to load and parse CSV data
            async function loadData() {
                try {
                    console.log('Starting data load...');
                    const response = await fetch('data/Colgate Diaspora - Sheet6.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    console.log('CSV loaded, first 100 chars:', csvText.substring(0, 100));
                    
                    leagueData = parseCSV(csvText);
                    console.log('Parsed data:', leagueData.slice(0, 2));
                    
                    processData();
                    initializeTables();
                } catch (error) {
                    console.error('Error loading data:', error);
                    showError('Error loading data: ' + error.message);
                }
            }

            // Parse CSV text into array of objects
            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                console.log('Number of lines:', lines.length);
                
                if (lines.length < 2) {
                    throw new Error('CSV file appears to be empty or malformed');
                }

                const headers = lines[0].split(',');
                console.log('Headers:', headers);

                return lines.slice(1)
                    .filter(line => line.trim())
                    .map(line => {
                        const values = line.split(',');
                        return {
                            Team: values[0],
                            Wins: parseInt(values[1]) || 0,  // w
                            Losses: parseInt(values[2]) || 0, // l
                            Ties: parseInt(values[3]) || 0,   // t
                            PointsFor: parseFloat(values[4]) || 0,  // PF
                            PointsAgainst: parseFloat(values[5]) || 0, // PA
                            FAverageTotal: parseFloat(values[6]) || 0, // F-average
                            AAverageTotal: parseFloat(values[7]) || 0, // A-average
                            Playoffs: values[8] || '',        // playoffs?
                            Championship: values[9] || '',     // championship
                            Participated: values[10] || '',    // Participated?
                            Season: values[11] || ''          // Season
                        };
                    });
            }

            // Process data for all-time standings
            function processData() {
                console.log('Processing data...');
                allTimeStats = leagueData.reduce((acc, row) => {
                    if (!acc[row.Team]) {
                        acc[row.Team] = {
                            seasons: new Set(),
                            wins: 0,
                            losses: 0,
                            ties: 0,
                            pointsFor: 0,
                            pointsAgainst: 0,
                            playoffs: 0,
                            championships: 0,
                            fAverageTotal: 0,
                            aAverageTotal: 0,
                            gamesPlayed: 0
                        };
                    }
                    
                    const stats = acc[row.Team];
                    stats.seasons.add(row.Season);
                    stats.wins += row.Wins;
                    stats.losses += row.Losses;
                    stats.ties += row.Ties;
                    stats.pointsFor += row.PointsFor;
                    stats.pointsAgainst += row.PointsAgainst;
                    stats.playoffs += row.Playoffs === '1' ? 1 : 0;
                    stats.championships += row.Championship === '1' ? 1 : 0;
                    stats.fAverageTotal += row.FAverageTotal;
                    stats.aAverageTotal += row.AAverageTotal;
                    stats.gamesPlayed += row.Wins + row.Losses + row.Ties;
                    
                    return acc;
                }, {});

                // Populate season filter
                const seasons = [...new Set(leagueData.map(row => row.Season))].sort().reverse();
                const select = document.getElementById('seasonSelect');
                select.innerHTML = '<option value="all">All Seasons</option>' +
                    seasons.map(season => `<option value="${season}">${season}</option>`).join('');
            }

            // Initialize DataTables
            function initializeTables() {
                console.log('Initializing tables...');
                try {
                    // Season Table
                    $('#seasonData thead tr').html(`
                        <th>Team</th>
                        <th>W</th>
                        <th>L</th>
                        <th>T</th>
                        <th>PF</th>
                        <th>PA</th>
                        <th>F-average</th>
                        <th>A-average</th>
                        <th>Playoffs?</th>
                        <th>Championship</th>
                        <th>Participated?</th>
                        <th>Season</th>
                    `);

                    const seasonTable = $('#seasonData').DataTable({
                        data: leagueData,
                        columns: [
                            { data: 'Team' },
                            { data: 'Wins' },
                            { data: 'Losses' },
                            { data: 'Ties' },
                            { data: 'PointsFor' },
                            { data: 'PointsAgainst' },
                            { data: 'FAverageTotal' },
                            { data: 'AAverageTotal' },
                            { data: 'Playoffs' },
                            { data: 'Championship' },
                            { data: 'Participated' },
                            { data: 'Season' }
                        ],
                        order: [[11, 'desc']], // Sort by Season by default
                        pageLength: 25
                    });

                    // Add event listener for season selection
                    $('#seasonSelect').on('change', function() {
                        const selectedSeason = $(this).val();
                        filterBySeason(selectedSeason);
                    });

                    // Update All-Time Standings table
                    $('#standingsData thead tr').html(`
                        <th>Team</th>
                        <th>w</th>
                        <th>l</th>
                        <th>t</th>
                        <th>Seasons</th>
                        <th>Win Percentage</th>
                        <th>PF</th>
                        <th>PA</th>
                        <th>F-average Tot</th>
                        <th>A-average Tot</th>
                        <th>Playoff Appe</th>
                        <th>Championship</th>
                    `);

                    const standingsData = Object.entries(allTimeStats).map(([team, stats]) => ({
                        team,
                        wins: stats.wins,
                        losses: stats.losses,
                        ties: stats.ties,
                        seasons: stats.seasons.size,
                        winPct: stats.gamesPlayed > 0 ? 
                            ((stats.wins / stats.gamesPlayed) * 100).toFixed(1) + '%' : 
                            '0.0%',
                        pointsFor: (stats.pointsFor / stats.seasons.size).toFixed(1),
                        pointsAgainst: (stats.pointsAgainst / stats.seasons.size).toFixed(1),
                        fAverageTotal: (stats.fAverageTotal / stats.seasons.size).toFixed(1),
                        aAverageTotal: (stats.aAverageTotal / stats.seasons.size).toFixed(1),
                        playoffs: stats.playoffs,
                        championships: stats.championships
                    }));

                    const standingsTable = $('#standingsData').DataTable({
                        data: standingsData,
                        columns: [
                            { data: 'team', title: 'Team' },
                            { data: 'wins', title: 'w' },
                            { data: 'losses', title: 'l' },
                            { data: 'ties', title: 't' },
                            { data: 'seasons', title: 'Seasons' },
                            { data: 'winPct', title: 'Win Percentage' },
                            { data: 'pointsFor', title: 'PF' },
                            { data: 'pointsAgainst', title: 'PA' },
                            { data: 'fAverageTotal', title: 'F-average Tot' },
                            { data: 'aAverageTotal', title: 'A-average Tot' },
                            { data: 'playoffs', title: 'Playoff Appe' },
                            { data: 'championships', title: 'Championship' }
                        ],
                        pageLength: 15,
                        order: [[11, 'desc'], [10, 'desc'], [5, 'desc']]
                    });

                    console.log('Tables initialized successfully');
                } catch (error) {
                    console.error('Error initializing tables:', error);
                    showError('Error initializing tables: ' + error.message);
                }
            }

            // View toggle handlers
            $('#seasonView').click(function() {
                $(this).addClass('active');
                $('#allTimeView').removeClass('active');
                $('#seasonTable').show();
                $('#allTimeTable').hide();
            });

            $('#allTimeView').click(function() {
                $(this).addClass('active');
                $('#seasonView').removeClass('active');
                $('#seasonTable').hide();
                $('#allTimeTable').show();
            });

            // Start loading data
            console.log('Document ready, loading data...');
            loadData();
        });
    </script>
</body>
</html>